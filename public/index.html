<!-- Renderã®URLã§ã™ -->
<!-- https://eshiritori.onrender.com/ -->
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ã¤ãªã’ï¼ã€€çµµã—ã‚Šã¨ã‚Š</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            flex-direction: column;
            padding: 20px;
        }

        .chat {
            display: flex;
            flex-direction: column;
            height: 80vh;
            /* ãƒãƒ£ãƒƒãƒˆã®å¹…èª¿æ•´(ã‚«ãƒ¯ã‚°ãƒ) */
            width: calc(100vw - 70px);
            margin-bottom: 20px;
            margin-left: auto;
            margin-right: auto;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            list-style: none;
            padding: 0;
            margin: 0;
            /* è¿½åŠ  */
            border: 1px solid #ccc;
            padding: 10px;
        }

        /* è‡ªåˆ†ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å³å¯„ã›(ã‚«ãƒ¯ã‚°ãƒ) */
        .my-message {
            align-self: flex-end;
            margin-left: auto;
            text-align: right;
            color: blue;
        }

        /* è‡ªåˆ†ä»¥å¤–ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯å·¦å¯„ã›(ã‚«ãƒ¯ã‚°ãƒ) */
        .other-message {
            align-self: flex-start;
            margin-right: auto;
            text-align: left;
            color: green;
        }

        /* é¸æŠãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .number-input {
            width: 80px;
            padding: 5px;
            font-size: 16px;
        }

        /* ä»Šã®äººã¯èµ¤æ–‡å­—(ã‚«ãƒ¯ã‚°ãƒ) */
        .current-turn-player {
            color: red;
            font-weight: bold;
        }

        .form {
            display: flex;
            /* è¿½åŠ  */
            margin-top: 10px;
        }

        .input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
        }

        .submit {
            padding: 10px;
            border: 1px solid #ccc;
            background: #eee;
            cursor: pointer;
        }

        /* æ¨ªä¸¦ã³(ã‚ªã‚¿ãƒ‹è¿½åŠ ) */
        .box {
            display: flex;
            align-items: center;
            margin-top: 20px;
        }

        /* ãƒ”ãƒƒã‚«ãƒ¼ã®è¦‹ãŸç›®ã‚’å¤‰æ›´(ã‚ªã‚¿ãƒ‹è¿½åŠ ) */
        input[type="color"] {
            width: 32px;
            height: 32px;
            padding: 0;
            display: inline-block;
            margin-right: 18px;
            border: 1px solid rgb(0, 0, 0);
            border-radius: 50%;
        }

        input[type="color"]::-webkit-color-swatch,
        input[type="color"]::-webkit-color-swatch-wrapper {
            border: none;
            padding: 0;
            border-radius: 50%;
        }

        /* [type="text"] ã‚³ãƒ¼ãƒ‰å…¥åŠ›ã‚¨ãƒªã‚¢ã®è¦‹ãŸç›®ã‚’å¤‰æ›´(ã‚ªã‚¿ãƒ‹è¿½åŠ ) */
        input[type="text"] {
            border: 1px solid rgb(0, 0, 0);
            padding: 5px;
        }

        #eraserToggle {
            margin-left: 10px;
        }

        /* ç·šã®å¤ªã•ã‚„ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã®å ´æ‰€ã‚’ä¸€å¾‹ç®¡ç†(ã‚ªã‚¬ãƒ¯) */
        .drawing-tools {
            display: flex;
            align-items: center;
            margin-top: 10px;
            gap: 15px;
            /* è¦ç´ é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ */
            flex-wrap: wrap;
            /* è¦ç´ ãŒåã¾ã‚‰ãªã„å ´åˆã«æŠ˜ã‚Šè¿”ã™ */
            justify-content: center;
            /* ãƒ„ãƒ¼ãƒ«ã‚’ä¸­å¤®å¯„ã› */
        }

        /* 2ã¤ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’æ¨ªä¸¦ã³ã«ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠ(ã‚ªã‚¬ãƒ¯) */
        .canvases-container {
            display: flex;
            gap: 20px;
            /* ã‚­ãƒ£ãƒ³ãƒã‚¹é–“ã®ã‚¹ãƒšãƒ¼ã‚¹ */
            margin: 20px auto;
            /* ä¸Šä¸‹ã®ä½™ç™½ã¨å·¦å³ä¸­å¤®å¯„ã› */
            justify-content: center;
            /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä¸­å¤®å¯„ã› */
            align-items: flex-start;
            /* ä¸Šç«¯ã‚’æƒãˆã‚‹ */
            position: relative;
            /* å­è¦ç´ ã®çµ¶å¯¾é…ç½®ã®ãŸã‚(ã‚ªã‚¿ãƒ‹è¿½åŠ ) */
        }

        .canvases-container canvas {
            display: block;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #receivedCanvas {
            border: solid 1px red;
            /* å—ä¿¡ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ã®æ ç·š */
        }

        #canvas {
            border: solid 1px black;
            /* æç”»ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ã®æ ç·š */
        }

        /* ã‚«ãƒ¼ã‚½ãƒ«ã‚¬ã‚¤ãƒ‰ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’é‡ã­ã¦è¡¨ç¤º(ã‚ªã‚¿ãƒ‹è¿½åŠ ) */
        #cursorCanvas {
            position: absolute;
            pointer-events: none;
            top: 0;
            left: 0;
        }

        /* UIã®è¡¨ç¤º/éè¡¨ç¤ºåˆ¶å¾¡(ã‚«ãƒ¯ã‚°ãƒ) */
        .hidden {
            display: none !important;
        }

        #standbyMessage {
            font-size: 2em;
            text-align: center;
            padding: 50px;
            border: 2px solid #ddd;
            background-color: #f0f0f0;
            margin: 50px auto;
            width: 80%;
            box-sizing: border-box;
        }
    </style>
</head>

<body>
    <div id="game-area">
        <div class="chat">
            <ul class="messages"></ul>
            <form class="form" id="chatForm">
                <input class="input" id="chatInput" autocomplete="off" />
                <button class="submit" id="chatSubmitButton">Send</button>
            </form>
        </div>

        <div class="game-controls">
            <!-- ãƒ©ã‚¦ãƒ³ãƒ‰æ•°é¸æŠ(ã‚¹ãƒ”ãƒ³ãƒœã‚¿ãƒ³æ–¹å¼)(ã‚«ãƒ¯ã‚°ãƒ) -->
            <label>
                ãƒ©ã‚¦ãƒ³ãƒ‰æ•°:
                <input type="number" id="roundSelect" class="number-input" min="1" max="10" step="1" value="3">
            </label>
            <!-- ã‚¿ãƒ¼ãƒ³æ•°é¸æŠ(ã‚¹ãƒ”ãƒ³ãƒœã‚¿ãƒ³æ–¹å¼)(ã‚«ãƒ¯ã‚°ãƒ) -->
            <label style="margin-left: 20px;">
                ã‚¿ãƒ¼ãƒ³æ•°:
                <input type="number" id="turnSelect" class="number-input" min="1" max="5" step="1" value="2">
            </label>
            <!-- ã‚²ãƒ¼ãƒ é–‹å§‹ãƒœã‚¿ãƒ³(ã‚«ãƒ¯ã‚°ãƒ) -->
            <button id="startButton" style="margin-left: 20px;">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
        </div>

        <!-- ãƒ«ãƒ¼ãƒ ã®çŠ¶æ³(ã‚«ãƒ¯ã‚°ãƒ) -->
        <div id="gameStatus" style="font-size: 20px; font-weight: bold; margin: 10px 0;">
            <span id="firstChar">æœ€åˆã®æ–‡å­—ã¯ </span>
            <span id="playerCountDisplay"></span>
            <br />
            <!-- èª°ã®ã‚¿ãƒ¼ãƒ³ã‹(ã‚«ãƒ¯ã‚°ãƒ) -->
            <span id="currentTurnInfo"></span><span id="turnOrderDisplay" style="display: inline;"></span>
        </div>

        <!-- æ™‚é–“åˆ¶é™ã®è¡¨ç¤º(ã‚ªã‚¬ãƒ¯) -->
        <div id="timerDisplay" style="font-size: 24px; font-weight: bold; margin-bottom: 10px;"></div>

        <p id="standbyMessage" class="hidden"></p>
        <div id="drawingUI">

            <!-- ãµãŸã¤ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
            <div class="canvases-container">
                <canvas id="receivedCanvas" width="600" height="600"></canvas>
                <canvas id="canvas" width="600" height="600"></canvas>
                <!-- ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¬ã‚¤ãƒ‰ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹(ã‚ªã‚¿ãƒ‹è¿½åŠ ) -->
                <canvas id="cursorCanvas" width="600" height="600"
                    style="position: absolute; pointer-events: none;"></canvas>
            </div>

            <div class="drawing-tools">
                <!-- ç·šã®å¤ªã•(ã‚ªã‚¿ãƒ‹è¿½åŠ ) -->
                <label>
                    ç·šã®å¤ªã•:
                    <input type="range" id="lineWidthSlider" min="1" max="20" value="5">
                </label>
                <!-- ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼(ã‚ªã‚¿ãƒ‹è¿½åŠ ) -->
                <input type="color" id="colorPicker" value="#000000">
                <!-- æ¶ˆã—ã‚´ãƒ (ã‚ªã‚¿ãƒ‹è¿½åŠ ) -->
                <button id="eraserToggle">æ¶ˆã—ã‚´ãƒ  OFF</button>
                <!-- Undo/Redo(ã‚ªã‚¿ãƒ‹è¿½åŠ ) -->
                <button id="undoBtn">â†©</button>
                <button id="redoBtn">â†ª</button>

                <!-- sendPictureãƒœã‚¿ãƒ³è¿½åŠ (ã‚ªã‚¬ãƒ¯) -->
                <button id="sendPictureButton">Send Picture</button>
            </div>
        </div>
    </div>

    <script>
        function main() {
            // myIdã‚’è‡ªåˆ†ã§å…¥åŠ›ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´(å…¥åŠ›ãªã—ãªã‚‰ãƒ©ãƒ³ãƒ€ãƒ )(ã‚«ãƒ¯ã‚°ãƒ)
            const myId = prompt("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")?.trim() || self.crypto.randomUUID().substr(0, 8);
            const host = location.origin.replace(/^http/, 'ws')
            const ws = new WebSocket(host + '/ws')

            //å…¥å®¤ã—ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†(é‡è¤‡ã‚’è¨±ã•ãªã„)(ã‚«ãƒ¯ã‚°ãƒ)
            let players = new Set()

            //ã‚²ãƒ¼ãƒ é–‹å§‹çŠ¶æ…‹ã‚’ç®¡ç†(ã‚ªã‚¬ãƒ¯)
            let gameStarted = false;
            //å›ç­”ã‚’ä¿å­˜ã™ã‚‹é…åˆ—(ã‚ªã‚¬ãƒ¯)
            let answers = [];
            //æã‹ã‚ŒãŸç”»åƒã‚’ä¿å­˜ã™ã‚‹é…åˆ—(ã‚ªã‚¬ãƒ¯)
            let drawnImages = [];
            //ä¸€æ™‚çš„ã«æã‹ã‚ŒãŸç”»åƒã‚’ä¿æŒã™ã‚‹(ã‚ªã‚¬ãƒ¯)
            let currentDrawingData = null;

            //æ›¸ã„ãŸæƒ…å ±ã‚’ä¿ç®¡ã™ã‚‹(ã‚ªã‚¿ãƒ‹è¿½åŠ )
            let currentRemoteStroke = [];

            //ãƒãƒ£ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¨ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®ç®¡ç†(ã‚«ãƒ¯ã‚°ãƒ)
            const startButton = document.getElementById('startButton')
            const chatForm = document.getElementById('chatForm');
            const gameControls = document.querySelector('.game-controls');
            const standbyMessageElement = document.getElementById('standbyMessage');
            const canvasesContainer = document.querySelector('.canvases-container');
            const firstCharEl = document.getElementById('firstChar');

            const turnOrderDisplay = document.getElementById('turnOrderDisplay');
            const currentTurnInfo = document.getElementById('currentTurnInfo'); // è¿½åŠ 

            const playerCountDisplay = document.getElementById('playerCountDisplay');

            //ãƒãƒ£ãƒƒãƒˆå…¥åŠ›æ¬„ã¨ã€sendãƒœã‚¿ãƒ³ã€ç”»åƒsendãƒœã‚¿ãƒ³(ã‚ªã‚¬ãƒ¯)
            const chatInput = document.getElementById('chatInput'); // chatInputã®IDã‚’è¿½åŠ 
            const chatSubmitButton = document.getElementById('chatSubmitButton'); // chatSubmitButtonã®IDã‚’è¿½åŠ 
            const sendPictureButton = document.getElementById('sendPictureButton'); // æ–°ã—ã„ãƒœã‚¿ãƒ³ã‚’å–å¾—
            const drawingToolsContainer = document.querySelector('.drawing-tools');

            const timerDisplay = document.getElementById('timerDisplay');

            const gameArea = document.getElementById('game-area'); // ã‚²ãƒ¼ãƒ è¦ç´ ã®è¦ªã‚³ãƒ³ãƒ†ãƒŠï¼ˆã‚ªã‚¬ãƒ¯)

            //æç”»ãƒ¢ãƒ¼ãƒ‰ã‹ã€å›ç­”å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã‹(ã‚ªã‚¬ãƒ¯)
            let isDrawingTurn = false; //çµµã‚’æãã‚¿ãƒ¼ãƒ³ã‹ã©ã†ã‹
            let isAnsweringTurn = false; //å›ç­”å…¥åŠ›ã‚¿ãƒ¼ãƒ³ã‹ã©ã†ã‹

            // --- åˆæœŸè¨­å®š(ã‚«ãƒ¯ã‚°ãƒ) ---
            function initializeUI() {
                // ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã¯ã€ã‚²ãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã¨ãƒãƒ£ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ã¿è¡¨ç¤º
                gameControls.classList.remove('hidden');
                chatForm.classList.remove('hidden');
                canvasesContainer.classList.remove('hidden');
                drawingToolsContainer.classList.remove('hidden');
                sendPictureButton.classList.add('hidden');
                standbyMessageElement.classList.add('hidden');
                timerDisplay.classList.add('hidden');
                firstCharEl.classList.add('hidden');
                turnOrderDisplay.classList.remove('hidden'); // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°ã¨ã‚¿ãƒ¼ãƒ³é †ã¯å¸¸ã«è¡¨ç¤º
                currentTurnInfo.classList.add('hidden'); // ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã¯éè¡¨ç¤º
                enableChatInput(); // ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã¯ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ç„¡åŠ¹
            }

            initializeUI(); // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–

            // ã‚²ãƒ¼ãƒ é–‹å§‹ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚‰(ã‚«ãƒ¯ã‚°ãƒ)
            startButton.onclick = () => {
                const round = document.getElementById('roundSelect').value
                const turn = document.getElementById('turnSelect').value
                const playerCount = players.size

                const confirmed = confirm(
                    `å…¥å®¤äººæ•°: ${playerCount}äºº\nãƒ©ã‚¦ãƒ³ãƒ‰æ•°: ${round}ãƒ©ã‚¦ãƒ³ãƒ‰\nã‚¿ãƒ¼ãƒ³æ•°: ${turn}ã‚¿ãƒ¼ãƒ³\n\nã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ`
                )

                if (confirmed) {
                    ws.send(JSON.stringify({ type: 'start', rounds: parseInt(round), turns: parseInt(turn) }))

                    gameStarted = true; //ã‚²ãƒ¼ãƒ é–‹å§‹çŠ¶æ…‹ã«ã™ã‚‹(ã‚ªã‚¬ãƒ¯)
                    //ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã¯æç”»ã‚¿ãƒ¼ãƒ³(ã‚ªã‚¬ãƒ¯)
                    // setDrawingTurnUI();
                }
            }

            //éå»ã«æ›¸ã„ãŸã‚‚ã®ã‚’å…¥ã‚Œã‚‹é…åˆ—(ã‚ªã‚¿ãƒ‹è¿½åŠ )
            let drawingHistory = [];
            let undoneHistory = [];

            //
            //2ã¤ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—(ã‚ªã‚¬ãƒ¯)
            const receivedCanvas = document.getElementById('receivedCanvas');
            const receivedCtx = receivedCanvas.getContext('2d');
            const canvas = document.getElementById('canvas')
            const ctx = canvas.getContext('2d')

            //ã‚«ãƒ¼ã‚½ãƒ«ã‚¬ã‚¤ãƒ‰ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—(ã‚ªã‚¿ãƒ‹è¿½åŠ )
            const cursorCanvas = document.getElementById('cursorCanvas');
            const cursorCtx = cursorCanvas.getContext('2d');

            // å³ã® #canvas ã‚’åŸºæº–ã«åº§æ¨™èª¿æ•´(ã‚ªã‚¿ãƒ‹è¿½åŠ )
            function updateCursorCanvasPosition() {
                const canvasRect = canvas.getBoundingClientRect();
                cursorCanvas.style.left = canvas.offsetLeft + 'px';
                cursorCanvas.style.top = canvas.offsetTop + 'px';
            }
            updateCursorCanvasPosition();

            //ColorPickerã®è‰²ã€ç·šã®å¤ªã•ã€æ¶ˆã—ã‚´ãƒ ã‚’canvasã«åæ˜ ã•ã›ã‚‹(ã‚ªã‚¿ãƒ‹è¿½åŠ )
            const colorPicker = document.getElementById('colorPicker');
            const lineWidthSlider = document.getElementById('lineWidthSlider');
            const eraserToggle = document.getElementById('eraserToggle');

            ctx.strokeStyle = colorPicker.value;
            ctx.lineWidth = lineWidthSlider.value;

            colorPicker.addEventListener('input', () => {
                if (!eraserMode) {
                    ctx.strokeStyle = colorPicker.value;
                }
            });
            lineWidthSlider.addEventListener('input', () => {
                ctx.lineWidth = lineWidthSlider.value;
            });

            let drawing = false;
            let eraserMode = false;

            //ãƒˆã‚°ãƒ«(ã‚ªã‚¿ãƒ‹è¿½åŠ )
            eraserToggle.addEventListener('click', () => {
                eraserMode = !eraserMode;
                eraserToggle.textContent = eraserMode ? "æ¶ˆã—ã‚´ãƒ  ON" : "æ¶ˆã—ã‚´ãƒ  OFF";
                if (eraserMode) {
                    ctx.strokeStyle = "#ffffff";//â†å®Ÿéš›ã«æ¶ˆã—ã¦ã„ãªã„ç™½ã§ä¸Šå¡—ã‚Šã—ã¦ã„ã‚‹
                } else {
                    ctx.strokeStyle = colorPicker.value;
                }
            });

            //redo/undoãƒœã‚¿ãƒ³è¿½åŠ (ã‚ªã‚¿ãƒ‹è¿½åŠ )
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');

            //undoãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§WebSocketã«é€ä¿¡(ã‚ªã‚¿ãƒ‹è¿½åŠ )
            undoBtn.addEventListener('click', () => {
                ws.send(JSON.stringify({ type: 'undo' }));
            });

            //redoãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§WebSocketã«é€ä¿¡(ã‚ªã‚¿ãƒ‹è¿½åŠ )
            redoBtn.addEventListener('click', () => {
                ws.send(JSON.stringify({ type: 'redo' }));
            });

            //ç¾åœ¨æç”»ã—ã¦ã„ã‚‹ç·šã®åº§æ¨™ã‚’ä¸€æ™‚çš„ã«ä¿å­˜ã™ã‚‹ãŸã‚ã®é…åˆ—(ã‚ªã‚¿ãƒ‹è¿½åŠ )
            let currentStroke = [];

            canvas.addEventListener('mousedown', (e) => {
                sendDrawingEvent(e.offsetX, e.offsetY, 'mousedown');
            });
            function mousedown() {
                drawing = true;
                ctx.beginPath();
            }

            //ãƒã‚¦ã‚¹ãŒå‹•ã„ãŸæ™‚ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚¬ã‚¤ãƒ‰ã‚’æç”»(ã‚ªã‚¿ãƒ‹è¿½åŠ )
            canvas.addEventListener('mousemove', (e) => {
                if (!gameStarted || !isDrawingTurn) return;

                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                const size = parseInt(lineWidthSlider.value) + 4;
                const half = size / 2;

                cursorCtx.clearRect(0, 0, cursorCanvas.width, cursorCanvas.height);

                // æç”»è‰²ã‚’å–å¾—ï¼ˆæ¶ˆã—ã‚´ãƒ æ™‚ã¯ç™½ï¼‰
                const colorValue = colorPicker?.value || '#000000';
                const drawColor = eraserMode ? '#ffffff' : colorValue;

                // å¡—ã‚Šã¤ã¶ã—è‰²
                let fillColor = drawColor;
                if (/^#[0-9A-F]{6}$/i.test(drawColor)) {
                    const r = parseInt(drawColor.substr(1, 2), 16);
                    const g = parseInt(drawColor.substr(3, 2), 16);
                    const b = parseInt(drawColor.substr(5, 2), 16);
                    fillColor = `rgba(${r}, ${g}, ${b}, 1.0)`; // å¡—ã‚Šè‰²
                }

                // æ ç·šã®è‰²ï¼ˆæ¶ˆã—ã‚´ãƒ æ™‚ã¯é»’ã€ãã‚Œä»¥å¤–ã¯åŒã˜è‰²ï¼‰
                const strokeColor = eraserMode ? 'glay' : fillColor;

                // æç”»
                cursorCtx.fillStyle = fillColor;
                cursorCtx.fillRect(x - half, y - half, size, size);

                cursorCtx.strokeStyle = strokeColor;
                cursorCtx.lineWidth = 1;
                cursorCtx.strokeRect(x - half, y - half, size, size);

                if (drawing) {
                    sendDrawingEvent(e.offsetX, e.offsetY, 'mousemove');
                }
            });

            function mousemove(x, y) {
                if (drawing) {
                    draw(x, y, true)
                }
            }

            canvas.addEventListener('mouseout', () => {
                cursorCtx.clearRect(0, 0, cursorCanvas.width, cursorCanvas.height);
            });

            canvas.addEventListener('mouseup', (e) => {
                sendDrawingEvent(e.offsetX, e.offsetY, 'mouseup')
            })
            //mouseupæ™‚ã«currentStrokeã‚’åˆæœŸåŒ–(ã‚ªã‚¿ãƒ‹è¿½åŠ )
            function mouseup() {
                drawing = false
                ctx.beginPath()
                if (currentStroke.length > 0) {
                    // ç¾åœ¨ã®ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã‚’ä¿å­˜
                    drawingHistory.push({
                        stroke: currentStroke,
                        color: ctx.strokeStyle,
                        width: ctx.lineWidth
                    });
                    currentStroke = []; // æ¬¡ã®ã‚¹ãƒˆãƒ­ãƒ¼ã‚¯ã«å‚™ãˆã¦ãƒªã‚»ãƒƒãƒˆ
                    undoneHistory = []; // æ–°ã—ã„æç”»ãŒã‚ã£ãŸã®ã§redoå±¥æ­´ã‚’ã‚¯ãƒªã‚¢
                }
            }

            canvas.addEventListener('mouseout', (e) => {
                sendDrawingEvent(e.offsetX, e.offsetY, 'mouseout')
            })
            function mouseout() {
                drawing = false
            }

            //drawé–¢æ•°ã‚’undo/redoã®ãŸã‚ã«å¤‰æ›´(ã‚ªã‚¿ãƒ‹è¿½åŠ )
            function draw(x, y, dragging) {
                if (dragging) {
                    ctx.lineTo(x, y);
                    ctx.stroke();
                    currentStroke.push({ x, y });
                } else {
                    ctx.moveTo(x, y);
                    currentStroke.push({ x, y });
                }
            }

            //canvasã‚’å†æç”»ã™ã‚‹éš›ã«å¿…è¦(ã‚ªã‚¿ãƒ‹è¿½åŠ )
            function redraw() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                for (let item of drawingHistory) {
                    ctx.strokeStyle = item.color;
                    ctx.lineWidth = item.width;
                    ctx.beginPath();
                    const points = item.stroke;
                    for (let i = 0; i < points.length; i++) {
                        const p = points[i];
                        if (i === 0) {
                            ctx.moveTo(p.x, p.y);
                        } else {
                            ctx.lineTo(p.x, p.y);
                        }
                    }
                    ctx.stroke();
                }
            }

            // æç”»ãƒ„ãƒ¼ãƒ«ï¼ˆCanvas, ColorPicker, LineWidthSliderï¼‰ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹(ã‚ªã‚¬ãƒ¯)
            function enableDrawingTools() {
                canvas.style.pointerEvents = 'auto'; // æç”»å¯èƒ½ã«
                colorPicker.disabled = false;
                lineWidthSlider.disabled = false;
                eraserToggle.disabled = false; // æ¶ˆã—ã‚´ãƒ ã‚‚æœ‰åŠ¹ã«
                undoBtn.disabled = false; //undoã‚‚æœ‰åŠ¹ã«(ã‚ªã‚¿ãƒ‹è¿½åŠ )
                redoBtn.disabled = false; //redoã‚‚æœ‰åŠ¹ã«(ã‚ªã‚¿ãƒ‹è¿½åŠ )
                drawingToolsContainer.classList.remove('hidden'); // ãƒ„ãƒ¼ãƒ«ãƒãƒ¼è¡¨ç¤º
                //drawingToolsContainer.style.display = 'flex'; // æç”»ãƒ„ãƒ¼ãƒ«å…¨ä½“ã‚’è¡¨ç¤º
            }

            function disableDrawingTools() {
                canvas.style.pointerEvents = 'none'; // æç”»ã§ããªã„ã‚ˆã†ã«
                colorPicker.disabled = true;
                lineWidthSlider.disabled = true;
                eraserToggle.disabled = true; // æ¶ˆã—ã‚´ãƒ ã‚‚ç„¡åŠ¹ã«
                undoBtn.disabled = true; //undoã‚‚ç„¡åŠ¹ã«(ã‚ªã‚¿ãƒ‹è¿½åŠ )
                redoBtn.disabled = true; //redoã‚‚ç„¡åŠ¹ã«(ã‚ªã‚¿ãƒ‹è¿½åŠ )
                drawing = false; // æç”»ä¸­ãƒ•ãƒ©ã‚°ã‚’ã‚ªãƒ•ã«ã™ã‚‹
                drawingToolsContainer.classList.add('hidden');
                //drawingToolsContainer.style.display = 'none'; // æç”»ãƒ„ãƒ¼ãƒ«å…¨ä½“ã‚’éè¡¨ç¤º
            }

            //é€ä¿¡ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã« color, width, eraser ã‚’è¿½åŠ (ã‚ªã‚¿ãƒ‹è¿½åŠ )
            function sendDrawingEvent(x, y, control) {
                const message = JSON.stringify({
                    x,
                    y,
                    control,
                    color: eraserMode ? "#ffffff" : colorPicker.value,
                    width: lineWidthSlider.value,
                    eraser: eraserMode,
                    type: 'paint'
                });
                ws.send(message);
            }

            //åˆ¶é™æ™‚é–“ã‚’è¨­ã‘ã‚‹ãŸã‚ã®å‡¦ç†(ã‚ªã‚¬ãƒ¯)
            let countdownInterval; //ã‚¿ã‚¤ãƒãƒ¼IDã‚’ä¿æŒã™ã‚‹é–¢æ•°

            function startTimer(duration, onTimeout) {
                let timer = duration;

                clearInterval(countdownInterval);

                countdownInterval = setInterval(() => {
                    timerDisplay.textContent = `æ®‹ã‚Šæ™‚é–“: ${timer}ç§’`;
                    timerDisplay.classList.remove('hidden');//(ã‚«ãƒ¯ã‚°ãƒè¿½åŠ )

                    if (timer <= 0) {
                        clearInterval(countdownInterval);
                        onTimeout(); //æ™‚é–“åˆ‡ã‚Œã®å‡¦ç†
                    }
                    timer--;
                }, 1000);
            }

            // --- ã‚²ãƒ¼ãƒ UIã‚’åˆæœŸçŠ¶æ…‹ã«æˆ»ã™é–¢æ•°ã‚’å®šç¾©(ã‚ªã‚¬ãƒ¯) ---
            function resetClientUI() {
                // å…¨ã¦ã®ã‚²ãƒ¼ãƒ é–¢é€£UIã‚’éè¡¨ç¤ºã«ã™ã‚‹
                gameControls.classList.add('hidden'); // ã‚²ãƒ¼ãƒ é–‹å§‹è¨­å®šã‚‚ä¸€æ—¦éš ã™
                drawingToolsContainer.classList.add('hidden');
                canvasesContainer.classList.add('hidden');
                chatForm.classList.add('hidden');
                firstCharEl.classList.add('hidden');
                turnOrderDisplay.classList.add('hidden');
                currentTurnInfo.classList.add('hidden');
                timerDisplay.classList.add('hidden');
                standbyMessageElement.classList.add('hidden');
                sendPictureButton.classList.add('hidden');
                undoButton.classList.add('hidden');
                redoButton.classList.add('hidden');
                clearCanvasButton.classList.add('hidden'); // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³ã‚‚éè¡¨ç¤ºã«

                const resultsContainer = document.getElementById('gameResults');
                if (resultsContainer) {
                    resultsContainer.remove(); // ã“ã‚Œã§DOMã‹ã‚‰å‰Šé™¤ã•ã‚Œã‚‹
                }

                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                receivedCtx.clearRect(0, 0, receivedCanvas.width, receivedCanvas.height);
                canvas.classList.remove('hidden'); // è‡ªåˆ†ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã¯è¡¨ç¤º
                receivedCanvas.style.display = 'none'; // å—ä¿¡ã‚­ãƒ£ãƒ³ãƒã‚¹ã¯éè¡¨ç¤ºã«æˆ»ã™

                // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ã‚¯ãƒªã‚¢
                messagesDiv.innerHTML = '';

                // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                gameStarted = false;
                isDrawingTurn = false;
                isAnsweringTurn = false;
                answers = [];
                drawnImages = [];
                // myId ã¯ä¿æŒ (å†å‚åŠ ã®ãŸã‚)

                // åˆæœŸUIã‚’è¡¨ç¤º
                gameControls.classList.remove('hidden');
                chatForm.classList.remove('hidden');
                canvasesContainer.classList.remove('hidden');
                drawingToolsContainer.classList.remove('hidden');
                sendPictureButton.classList.add('hidden');
                standbyMessageElement.classList.add('hidden');
                timerDisplay.classList.add('hidden');
                firstCharEl.classList.add('hidden');
                turnOrderDisplay.classList.remove('hidden'); // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°ã¨ã‚¿ãƒ¼ãƒ³é †ã¯å¸¸ã«è¡¨ç¤º
                currentTurnInfo.classList.add('hidden'); // ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã¯éè¡¨ç¤º
                enableChatInput(); // ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã¯ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ç„¡åŠ¹
                console.log('[ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ] UIãŒåˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚');
            }

            //æç”»ã‚¿ãƒ¼ãƒ³ã€å›ç­”å…¥åŠ›ã‚¿ãƒ¼ãƒ³ã€ãƒãƒ£ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ãã‚Œãã‚Œã®å‡¦ç†(ã‚ªã‚¬ãƒ¯)
            function setDrawingTurnUI() {
                isDrawingTurn = true;
                isAnsweringTurn = false;

                // UIã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
                gameControls.classList.add('hidden'); // ã‚²ãƒ¼ãƒ è¨­å®šã¯éè¡¨ç¤º
                standbyMessageElement.classList.add('hidden'); // å¾…æ©Ÿãƒ¡ãƒƒã‚»ãƒ¼ã‚¸éè¡¨ç¤º
                canvasesContainer.classList.remove('hidden'); // ã‚­ãƒ£ãƒ³ãƒã‚¹è¡¨ç¤º
                drawingToolsContainer.classList.remove('hidden'); // æç”»ãƒ„ãƒ¼ãƒ«è¡¨ç¤º
                sendPictureButton.classList.remove('hidden'); // é€ä¿¡ãƒœã‚¿ãƒ³è¡¨ç¤º
                chatForm.classList.add('hidden'); // ãƒãƒ£ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ éè¡¨ç¤ºï¼ˆæç”»ä¸­ã¯å›ç­”ã®ã¿ï¼‰

                enableDrawingTools(); // æç”»ãƒ„ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ–
                ctx.clearRect(0, 0, canvas.width, canvas.height); // è‡ªåˆ†ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢
                // receivedCtx.clearRect(0, 0, receivedCanvas.width, receivedCanvas.height); // receivedCanvasã¯å‰ã®çµµã‚’ä¿æŒã™ã‚‹ãŸã‚ã‚¯ãƒªã‚¢ã—ãªã„
                drawingHistory = []; // æç”»å±¥æ­´ã‚‚ã‚¯ãƒªã‚¢
                undoneHistory = []; // UNDOå±¥æ­´ã‚‚ã‚¯ãƒªã‚¢

                chatInput.placeholder = "çµµã‚’æã„ã¦ã€ŒSend Pictureã€ã‚’æŠ¼ã—ã¦ãã ã•ã„";

                currentTurnInfo.textContent = `ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³: ã‚ãªãŸ (æç”»)`;
                currentTurnInfo.classList.remove('hidden');

                startTimer(60, () => {
                    alert("æç”»ã‚¿ãƒ¼ãƒ³æ™‚é–“åˆ‡ã‚Œï¼");
                    disableDrawingTools();
                    currentDrawingData = canvas.toDataURL('image/png');
                    drawnImages.push(currentDrawingData);
                    console.log("æç”»æ™‚é–“åˆ‡ã‚Œã«ã‚ˆã‚Šä¿å­˜ã•ã‚ŒãŸç”»åƒ:" + drawnImages);

                    ws.send(JSON.stringify({ type: 'image_sended', imageData: currentDrawingData }));
                    ws.send(JSON.stringify({ type: 'drawing_time_up' }));

                    setAnsweringTurnUI();
                    ws.send(JSON.stringify({ type: 'drawing_completed' }));
                });
            }

            function setAnsweringTurnUI() {
                isDrawingTurn = false;
                isAnsweringTurn = true;

                // UIã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
                gameControls.classList.add('hidden'); // ã‚²ãƒ¼ãƒ è¨­å®šã¯éè¡¨ç¤º
                standbyMessageElement.classList.add('hidden'); // å¾…æ©Ÿãƒ¡ãƒƒã‚»ãƒ¼ã‚¸éè¡¨ç¤º
                canvasesContainer.classList.remove('hidden'); // ã‚­ãƒ£ãƒ³ãƒã‚¹è¡¨ç¤º (å‰ã®çµµã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚)
                drawingToolsContainer.classList.add('hidden'); // æç”»ãƒ„ãƒ¼ãƒ«éè¡¨ç¤º
                sendPictureButton.classList.add('hidden'); // é€ä¿¡ãƒœã‚¿ãƒ³éè¡¨ç¤º
                chatForm.classList.remove('hidden'); // ãƒãƒ£ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º

                disableDrawingTools(); // æç”»ãƒ„ãƒ¼ãƒ«ã¯ç„¡åŠ¹åŒ–
                enableChatInput(); // ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ã‚’æœ‰åŠ¹åŒ–

                chatInput.placeholder = "ä½•ã‚’æã„ãŸã‹â€ã²ã‚‰ãŒãªã§â€å…¥åŠ›ã—ã¦ãã ã•ã„";
                chatInput.value = '';
                chatInput.focus();

                currentTurnInfo.textContent = `ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³: ã‚ãªãŸ (å›ç­”)`;
                currentTurnInfo.classList.remove('hidden');

                startTimer(30, () => {
                    alert("å›ç­”ã‚¿ãƒ¼ãƒ³æ™‚é–“åˆ‡ã‚Œï¼");
                    disableChatInput();

                    const text = chatInput.value.trim(); // ç¾åœ¨ã®å…¥åŠ›å€¤ã‚’å–å¾—ï¼ˆç©ºæ¬„ã®å ´åˆã‚‚è€ƒæ…®ï¼‰
                    ws.send(JSON.stringify({ id: myId, text: text, type: 'answer' }));
                    console.log("å›ç­”æ™‚é–“åˆ‡ã‚Œã«ã‚ˆã‚Šé€ä¿¡ã•ã‚ŒãŸå›ç­”:", { id: myId, text: text });
                    ws.send(JSON.stringify({ type: 'answering_time_up' }));
                    ws.send(JSON.stringify({ type: 'turn_end' }));
                });
            }
            // è‡ªåˆ†ã®ç•ªã˜ã‚ƒãªã„å¾…æ©ŸUI(ã‚«ãƒ¯ã‚°ãƒ)
            function setStandbyUI(currentTurnPlayerId, turnPhase) {
                isDrawingTurn = false;
                isAnsweringTurn = false;

                clearInterval(countdownInterval); // ã‚¿ã‚¤ãƒãƒ¼åœæ­¢
                timerDisplay.classList.add('hidden'); // ã‚¿ã‚¤ãƒãƒ¼éè¡¨ç¤º

                // UIã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
                gameControls.classList.add('hidden'); // ã‚²ãƒ¼ãƒ è¨­å®šã¯éè¡¨ç¤º
                canvasesContainer.classList.add('hidden'); // ã‚­ãƒ£ãƒ³ãƒã‚¹éè¡¨ç¤º
                drawingToolsContainer.classList.add('hidden'); // æç”»ãƒ„ãƒ¼ãƒ«éè¡¨ç¤º
                sendPictureButton.classList.add('hidden'); // é€ä¿¡ãƒœã‚¿ãƒ³éè¡¨ç¤º
                standbyMessageElement.classList.remove('hidden'); // å¾…æ©Ÿãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                chatForm.classList.remove('hidden'); // ãƒãƒ£ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º

                disableDrawingTools(); // æç”»ãƒ„ãƒ¼ãƒ«ã¯ç„¡åŠ¹åŒ–
                enableChatInput(); // ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ã‚’æœ‰åŠ¹åŒ–

                if (standbyMessageElement) {
                    standbyMessageElement.textContent = `${currentTurnPlayerId}ãŒ${turnPhase}ä¸­...`;
                }
                chatInput.placeholder = "ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›";

                currentTurnInfo.textContent = `ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³: ${currentTurnPlayerId} (${turnPhase})`;
                currentTurnInfo.classList.remove('hidden');
            }

            // ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°(ã‚ªã‚¬ãƒ¯)
            function disableChatInput() {
                chatInput.disabled = true;
                chatSubmitButton.disabled = true;
            }

            function enableChatInput() {
                chatInput.disabled = false;
                chatSubmitButton.disabled = false;
            }

            //ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ã£ãŸã¨ãã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé–¢æ•°(ã‚«ãƒ¯ã‚°ãƒ)
            function appendMessage(id, text, myId) {
                const messageList = document.querySelector('.messages')
                const li = document.createElement('li')
                li.textContent = id + ': ' + text
                if (id === myId) {
                    li.className = 'my-message'
                } else {
                    li.className = 'other-message'
                }
                messageList.appendChild(li)
            }

            // æ¥ç¶šæ™‚ã«å‚åŠ ã—ãŸã“ã¨ãˆãŠçŸ¥ã‚‰ã›ã‚‹(ã‚«ãƒ¯ã‚°ãƒ)
            ws.onopen = () => {
                ws.send(JSON.stringify({ type: 'join', id: myId }))
            };

            //å—ä¿¡å´ã« color, width, eraserã€€ã‚’è¿½åŠ (ã‚ªã‚¿ãƒ‹è¿½åŠ )
            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === 'paint') {
                    if (isDrawingTurn) {//è‡ªåˆ†ãŒæç”»ã™ã‚‹ã¨ãã®ã¿(ã‚«ãƒ¯ã‚°ãƒè¿½åŠ )
                        const { x, y, control, color, width } = msg;

                        ctx.strokeStyle = color || "#000000";
                        ctx.lineWidth = parseFloat(width) || 1;

                        if (control === 'mousedown') {
                            mousedown();
                            currentRemoteStroke = [{ x, y }];
                        } else if (control === 'mousemove') {
                            mousemove(x, y);
                            currentRemoteStroke.push({ x, y });
                        } else if (control === 'mouseup') {
                            mouseup();
                            drawingHistory.push({
                                stroke: [...currentRemoteStroke],
                                color: ctx.strokeStyle,
                                width: ctx.lineWidth
                            });
                            undoneHistory = [];
                            currentRemoteStroke = [];
                        } else if (control === 'mouseout') {
                            mouseout();
                        }
                    }
                    return
                }

                //undoå‡¦ç†(ã‚ªã‚¿ãƒ‹è¿½åŠ )ã€€è‡ªåˆ†ãŒæç”»ã™ã‚‹ã¨ãã®ã¿(ã‚«ãƒ¯ã‚°ãƒè¿½åŠ )
                if (msg.type === 'undo') {
                    if (isDrawingTurn && drawingHistory.length > 0) {
                        const lastStroke = drawingHistory.pop();
                        undoneHistory.push(lastStroke);
                        redraw();
                    }
                    return;
                }

                // Redoå‡¦ç†(ã‚ªã‚¿ãƒ‹è¿½åŠ )
                if (msg.type === 'redo') {
                    if (isDrawingTurn && undoneHistory.length > 0) {
                        const restored = undoneHistory.pop();
                        drawingHistory.push(restored);
                        redraw();
                    }
                    return;
                }

                //ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å—ä¿¡ã—ãŸã‚‰canvasã«è¡¨ç¤º(ã‚ªã‚¬ãƒ¯)
                if (msg.type === 'image_sended') {
                    const img = new Image();
                    img.onload = function () {
                        receivedCtx.clearRect(0, 0, receivedCanvas.width, receivedCanvas.height);
                        //  receivedCtx.drawImage(img, 0, 0);
                        receivedCtx.drawImage(img, 0, 0, receivedCanvas.width, receivedCanvas.height);

                    };
                    img.src = msg.imageData;
                    return
                }

                // åˆæœŸæƒ…å ±ãŒé€ã‚‰ã‚Œã¦ããŸã‚‰(ã‚«ãƒ¯ã‚°ãƒ)
                if (msg.type === 'init') {
                    // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®players Setã‚’ã‚µãƒ¼ãƒãƒ¼ã®æœ€æ–°çŠ¶æ…‹ã«åŒæœŸ
                    players = new Set(msg.players);
                    console.log('[ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ] initã‚’å—ä¿¡ã€‚ç¾åœ¨ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ•°:', players.size);

                    // å…¥å®¤äººæ•°ã®è¡¨ç¤ºã‚’æ›´æ–°
                    if (playerCountDisplay) { // 'playerCountDisplay' ãŒå­˜åœ¨ã™ã‚‹ãªã‚‰
                        playerCountDisplay.textContent = `å…¥å®¤äººæ•°: ${players.size}äºº`;
                    } else {
                        console.error('[ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ] playerCountDisplayè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚HTMLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    }

                    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®è¡¨ç¤ºï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
                    if (msg.chatHistory && msg.chatHistory.length > 0) {
                        msg.chatHistory.forEach(chatMsg => {
                            appendMessage(chatMsg.id, chatMsg.text, myId);
                        });
                    }
                    return;
                }

                // --- game_reset ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å‡¦ç†ã‚’è¿½åŠ (ã‚ªã‚¬ãƒ¯) ---
                if (msg.type === 'game_reset') {
                    console.log('[ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ] ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆé€šçŸ¥ã‚’å—ä¿¡ã€‚UIã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚');
                    resetClientUI();
                    return;
                }

                //äººæ•°æ›´æ–°ãŒé€ã‚‰ã‚Œã¦ããŸã‚‰ (ã‚«ãƒ¯ã‚°ãƒ)
                if (msg.type === 'player_count_update') {
                    console.log(`[ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ] player_count_updateã‚’å—ä¿¡: ${msg.count}äºº`);
                    if (playerCountDisplay) {
                        playerCountDisplay.textContent = `å…¥å®¤äººæ•°: ${msg.count}äºº`;
                    } else {
                        console.error('[ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ] playerCountDisplayè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚HTMLã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                    }
                    return;
                }

                //ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚‰(ã‚«ãƒ¯ã‚°ãƒ)
                if (msg.type === 'start') {
                    console.log("å—ã‘å–ã£ãŸturnOrder:", msg.turnOrder);
                    //ç”»é¢åˆ‡ã‚Šæ›¿ãˆ(ãƒãƒ£ãƒƒãƒˆç”»é¢ã€ã‚¿ãƒ¼ãƒ³ãƒ»ãƒ©ã‚¦ãƒ³ãƒ‰é¸æŠãƒœã‚¿ãƒ³ã‚’æ¶ˆã™)(ã‚«ãƒ¯ã‚°ãƒ)
                    gameControls.classList.add('hidden'); // ã‚²ãƒ¼ãƒ è¨­å®šã¯éè¡¨ç¤º

                    firstCharEl.textContent = 'æœ€åˆã®æ–‡å­—: ' + msg.firstChar;
                    firstCharEl.classList.remove('hidden');

                    const turnOrder = msg.turnOrder;
                    const currentTurn = turnOrder[0];

                    turnOrderDisplay.innerHTML = 'ã‚¿ãƒ¼ãƒ³é †: ' + turnOrder.map(id => {
                        const isCurrent = id === currentTurn;
                        return `<span class="${isCurrent ? 'current-turn-player' : ''}">${id}</span>`;
                    }).join(' â†’ ');
                    turnOrderDisplay.classList.remove('hidden');

                    // ãƒ‡ãƒãƒƒã‚°ç”¨ã«è¡¨ç¤º
                    console.log("æœ€åˆã®æ–‡å­—:", msg.firstChar);
                    console.log("ã‚¿ãƒ¼ãƒ³é †:", msg.turnOrder);

                    alert(`æœ€åˆã®æ–‡å­—: ${msg.firstChar}\nã‚¿ãƒ¼ãƒ³é †: ${msg.turnOrder.join(" â†’ ")}`);

                    gameStarted = true; //ã‚²ãƒ¼ãƒ é–‹å§‹çŠ¶æ…‹ã«ã™ã‚‹(ã‚ªã‚¬ãƒ¯)
                    //setDrawingTurnUI();
                    if (currentTurn === myId) {
                        setDrawingTurnUI(); // æœ€åˆã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯æç”»ã‚¿ãƒ¼ãƒ³
                    } else {
                        setStandbyUI(currentTurn, 'æç”»'); // ä»–ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯å¾…æ©Ÿï¼ˆæç”»ä¸­ï¼‰
                    }
                    return;
                }

                //æ¬¡ã®ã‚¿ãƒ¼ãƒ³(ã‚«ãƒ¯ã‚°ãƒ)
                if (msg.type === 'next_turn') {
                    const currentTurn = msg.currentTurn;
                    const turnOrder = msg.turnOrder;
                    const currentPhaseFromServer = msg.phase;

                    turnOrderDisplay.innerHTML = 'ã‚¿ãƒ¼ãƒ³é †: ' + turnOrder.map(id => {
                        return id === currentTurn
                            ? `<span style="color: red; font-weight: bold;">${id}</span>`
                            : `<span>${id}</span>`;
                    }).join(' â†’ ');
                    turnOrderDisplay.classList.remove('hidden');

                    // å¿…è¦ã«å¿œã˜ã¦UIåˆ‡ã‚Šæ›¿ãˆã‚‚ã“ã“ã§å®Ÿè¡Œ
                    if (currentTurn === myId) {
                        // è‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³
                        if (currentPhaseFromServer === 'drawing') {
                            setDrawingTurnUI(); // æç”»ã‚¿ãƒ¼ãƒ³UIã«åˆ‡ã‚Šæ›¿ãˆ
                        } else if (currentPhaseFromServer === 'answering') {
                            setAnsweringTurnUI(); // å›ç­”ã‚¿ãƒ¼ãƒ³UIã«åˆ‡ã‚Šæ›¿ãˆ
                        }
                    } else {
                        // ä»–ã®äººã®ã‚¿ãƒ¼ãƒ³ï¼ˆå¾…æ©Ÿç”»é¢ï¼‰
                        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰é€ã‚‰ã‚Œã¦ããŸãƒ•ã‚§ãƒ¼ã‚ºæƒ…å ±ã«åŸºã¥ã„ã¦ã€å¾…æ©Ÿãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª¿æ•´
                        setStandbyUI(currentTurn, currentPhaseFromServer === 'drawing' ? 'æç”»' : 'å›ç­”');
                    }
                    return; // next_turnã®å‡¦ç†ã‚’çµ‚ãˆã‚‹
                }

                if (msg.type === 'chat') {
                    const { id, text } = msg
                    //appendMessageé–¢æ•°ã§ã¾ã¨ã‚ãŸ(ã‚«ãƒ¯ã‚°ãƒ)
                    appendMessage(msg.id, msg.text, myId)
                }

                //å›ç­”ãŒé€ã‚‰ã‚ŒãŸã‚‰ã€ãƒãƒ£ãƒƒãƒˆã«ã¯è¡¨ç¤ºã›ãšå›ç­”ãƒªã‚¹ãƒˆã«ä¿å­˜(ã‚ªã‚¬ãƒ¯)
                if (msg.type === 'answer') {
                    const { id, text } = msg;
                    answers.push({ id, text });
                    console.log("ä¿å­˜ã•ã‚ŒãŸå›ç­”:", answers); // ãƒ‡ãƒãƒƒã‚°ç”¨
                    appendMessage('ã‚·ã‚¹ãƒ†ãƒ ', `${id}ãŒå›ç­”ã—ã¾ã—ãŸ`, myId); // å›ç­”ã‚‚ãƒãƒ£ãƒƒãƒˆã«è¡¨ç¤º
                    return
                    // ctx.clearRect(0, 0, canvas.width, canvas.height);
                }

                //å…¥å®¤ã—ãŸã‚‰(ã‚«ãƒ¯ã‚°ãƒ)
                if (msg.type === 'join') {
                    // å…¥å®¤ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ã‚»ãƒƒãƒˆã«è¿½åŠ (ã‚«ãƒ¯ã‚°ãƒ)
                    players.add(msg.id)
                    //å…¥å®¤äººæ•°ã®æ›´æ–°(ã‚«ãƒ¯ã‚°ãƒ)

                    appendMessage('ã‚·ã‚¹ãƒ†ãƒ ', `${msg.id}ãŒå…¥å®¤ã—ã¾ã—ãŸ`, myId); // å›ç­”ã‚‚ãƒãƒ£ãƒƒãƒˆã«è¡¨ç¤º
                    return
                }

                //é€€å®¤ã—ãŸã‚‰(ã‚«ãƒ¯ã‚°ãƒ)
                if (msg.type === 'leave') {
                    appendMessage('ã‚·ã‚¹ãƒ†ãƒ ', `${msg.id}ãŒé€€å®¤ã—ã¾ã—ãŸ`, myId);
                    return;
                }

                if (msg.type === 'game_end') {
                    // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢
                    clearInterval(countdownInterval);
                    timerDisplay.classList.add('hidden');

                    // å…¨ã¦ã®ã‚²ãƒ¼ãƒ é–¢é€£UIã‚’éè¡¨ç¤ºã«ã™ã‚‹
                    gameControls.classList.add('hidden');
                    canvasesContainer.classList.add('hidden');
                    drawingToolsContainer.classList.add('hidden');
                    sendPictureButton.classList.add('hidden');
                    chatForm.classList.add('hidden');
                    firstCharEl.classList.add('hidden');
                    turnOrderDisplay.classList.add('hidden');
                    currentTurnInfo.classList.add('hidden');
                    playerCountDisplay.classList.add('hidden'); // å¿…è¦ã§ã‚ã‚Œã°
                    standbyMessageElement.classList.add('hidden'); // æ—¢å­˜ã®å¾…æ©Ÿãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚éè¡¨ç¤ºã«ã™ã‚‹

                    // --- ã“ã“ã‹ã‚‰çµæœè¡¨ç¤ºUIã®æ§‹ç¯‰ ---
                    const resultsContainer = document.createElement('div');
                    resultsContainer.id = 'gameResults';
                    resultsContainer.style.textAlign = 'center';
                    resultsContainer.style.marginTop = '20px';
                    gameArea.appendChild(resultsContainer); // ã‚²ãƒ¼ãƒ ã‚¨ãƒªã‚¢ã«è¿½åŠ 

                    const gameEndTitle = document.createElement('h2');
                    gameEndTitle.textContent = 'ã‚²ãƒ¼ãƒ çµ‚äº†ï¼çµæœç™ºè¡¨ï¼ ğŸ‰';
                    gameEndTitle.style.color = '#333';
                    gameEndTitle.style.marginBottom = '30px';
                    resultsContainer.appendChild(gameEndTitle);

                    if (msg.gameRecord && msg.gameRecord.length > 0) {
                        const resultsList = document.createElement('div');
                        resultsList.style.display = 'flex';
                        resultsList.style.flexWrap = 'wrap';
                        resultsList.style.justifyContent = 'center';
                        resultsList.style.gap = '20px'; // è¦ç´ é–“ã®ã‚¹ãƒšãƒ¼ã‚¹
                        resultsContainer.appendChild(resultsList);

                        msg.gameRecord.forEach((record, index) => {
                            const turnResultDiv = document.createElement('div');
                            turnResultDiv.style.border = '1px solid #ccc';
                            turnResultDiv.style.padding = '15px';
                            turnResultDiv.style.borderRadius = '8px';
                            turnResultDiv.style.width = '280px'; // ã‚«ãƒ¼ãƒ‰å½¢å¼ã§è¡¨ç¤º
                            turnResultDiv.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
                            turnResultDiv.style.backgroundColor = '#fff';

                            const turnTitle = document.createElement('h3');
                            turnTitle.textContent = `ã‚¿ãƒ¼ãƒ³ ${index + 1} (${record.turnPlayerId}ã•ã‚“ã®æç”»)`;
                            turnTitle.style.color = '#555';
                            turnTitle.style.marginBottom = '10px';
                            turnResultDiv.appendChild(turnTitle);

                            // ç”»åƒã®è¡¨ç¤º
                            const img = document.createElement('img');
                            img.src = record.imageData;
                            img.style.maxWidth = '100%';
                            img.style.height = 'auto';
                            img.style.border = '1px solid #eee';
                            img.style.marginBottom = '10px';
                            turnResultDiv.appendChild(img);

                            // å›ç­”ã®è¡¨ç¤º
                            const answerText = document.createElement('p');
                            if (record.answer) {
                                answerText.innerHTML = `**å›ç­”:** ${record.answer} (${record.answerPlayerId}ã•ã‚“)`;
                                answerText.style.color = '#007bff';
                                answerText.style.fontWeight = 'bold';
                            } else {
                                answerText.textContent = 'å›ç­”ãªã—';
                                answerText.style.color = '#dc3545';
                            }
                            turnResultDiv.appendChild(answerText);

                            resultsList.appendChild(turnResultDiv);
                        });
                    } else {
                        const noResults = document.createElement('p');
                        noResults.textContent = 'ã‚²ãƒ¼ãƒ çµæœã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
                        noResults.style.color = '#888';
                        resultsContainer.appendChild(noResults);
                    }

                    // --- ãƒªã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®è¿½åŠ  ---
                    const restartButton = document.createElement('button');
                    restartButton.textContent = 'ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤ã™ã‚‹';
                    restartButton.style.marginTop = '30px';
                    restartButton.style.padding = '10px 20px';
                    restartButton.style.fontSize = '1.2em';
                    restartButton.style.cursor = 'pointer';
                    restartButton.style.borderRadius = '5px';
                    restartButton.onclick = () => {
                        console.log('[ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ] ã€Œã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã€ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚');
                        resetClientUI(); // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦åˆæœŸçŠ¶æ…‹ã«æˆ»ã™
                    };
                    resultsContainer.appendChild(restartButton);

                    // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                    gameStarted = false;
                    isDrawingTurn = false;
                    isAnsweringTurn = false;
                    // answersé…åˆ—ã‚„drawnImagesé…åˆ—ã¯ã€æ¬¡ã®ã‚²ãƒ¼ãƒ ã®ãŸã‚ã«ã‚¯ãƒªã‚¢ã•ã‚Œã‚‹ã¹ãã§ã™
                    // ã“ã‚Œã‚‰ã®é…åˆ—ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã§ã®ã¿ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ãƒªãƒ­ãƒ¼ãƒ‰ã§ã‚¯ãƒªã‚¢ã•ã‚Œã¾ã™

                    return;
                }
            }

            //ã‚²ãƒ¼ãƒ é–‹å§‹å‰ã®å‡¦ç†(ã‚ªã‚¬ãƒ¯)
            chatForm.onsubmit = function (e) {
                e.preventDefault()
                const input = document.querySelector('.input')
                const text = input.value

                if (!gameStarted) {
                    if (text !== '') { // ç©ºã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯é€ä¿¡ã—ãªã„
                        ws.send(JSON.stringify({ id: myId, text: text, type: 'chat' }));
                    }
                    input.value = ''
                    input.focus()
                    return;
                }

                //ã‚²ãƒ¼ãƒ ä¸­ã®å‡¦ç†(ã‚ªã‚¬ãƒ¯)
                if (isAnsweringTurn) {
                    if (text !== '') {
                        ws.send(JSON.stringify({ id: myId, text: text, type: 'answer' }));
                        // answers.push({ id: myId, text: text });
                        input.value = ''
                        input.focus()

                        console.log('sending turn_end');
                        ws.send(JSON.stringify({ type: 'turn_end' }));

                    }
                    //å›ç­”é€ä¿¡å¾Œæ¬¡ã®äººã®çµµã®ã‚¿ãƒ¼ãƒ³ã¸
                    //setDrawingTurnUI();
                }
                else { // ã‚²ãƒ¼ãƒ ä¸­ã®é€šå¸¸ãƒãƒ£ãƒƒãƒˆï¼ˆè‡ªåˆ†ã®ã‚¿ãƒ¼ãƒ³ã§ã¯ãªã„æ™‚ã€ã¾ãŸã¯æç”»ãƒ•ã‚§ãƒ¼ã‚ºã§ãƒãƒ£ãƒƒãƒˆã—ãŸã„å ´åˆãªã©ï¼‰(ã‚«ãƒ¯ã‚°ãƒ)
                    if (text !== '') {
                        ws.send(JSON.stringify({ id: myId, text: text, type: 'chat' }));
                    }
                    chatInput.value = '';
                    chatInput.focus();
                }
            }

            sendPictureButton.onclick = () => {
                if (gameStarted && isDrawingTurn) {
                    currentDrawingData = canvas.toDataURL('image/png');
                    drawnImages.push(currentDrawingData);
                    console.log("ä¿å­˜ã•ã‚ŒãŸç”»åƒ:" + drawnImages)

                    // æã‹ã‚ŒãŸç”»åƒã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
                    ws.send(JSON.stringify({ type: 'image_sended', imageData: currentDrawingData }));

                    setAnsweringTurnUI();
                    ws.send(JSON.stringify({ type: 'drawing_completed' })); // ã‚µãƒ¼ãƒãƒ¼ã«æç”»å®Œäº†ã‚’é€šçŸ¥(ã‚«ãƒ¯ã‚°ãƒè¿½åŠ )

                }
            }

            ws.onerror = function (error) {
                console.error('WebSocket Error: ', error)
            }
        }

        main()
    </script>
</body>

</html>